{"version":3,"sources":["../../src/Parser.ts","../../src/index.ts"],"names":["Parser","path","getRootDir","getBuildPath","fs"],"mappings":"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","file":"index.js","sourcesContent":["import * as path from 'node:path';\nimport * as fs from 'fs';\n\nimport Parser, { Language } from 'web-tree-sitter';\n\nimport { getRootDir, getBuildPath } from '@cs/context-utils';\n\nexport class TreeSitter {\n  private static nameToLanguage = new Map<string, Language>();\n\n  public static supportedLanguages: { [key: string]: string } = {\n    cpp: 'cpp',\n    hpp: 'cpp',\n    cc: 'cpp',\n    cxx: 'cpp',\n    hxx: 'cpp',\n    cp: 'cpp',\n    hh: 'cpp',\n    inc: 'cpp',\n    cs: 'c_sharp',\n    c: 'c',\n    h: 'c',\n    css: 'css',\n    php: 'php',\n    phtml: 'php',\n    php3: 'php',\n    php4: 'php',\n    php5: 'php',\n    php7: 'php',\n    phps: 'php',\n    'php-s': 'php',\n    bash: 'bash',\n    sh: 'bash',\n    json: 'json',\n    ts: 'typescript',\n    mts: 'typescript',\n    cts: 'typescript',\n    tsx: 'tsx',\n    elm: 'elm',\n    js: 'javascript',\n    jsx: 'javascript',\n    mjs: 'javascript',\n    cjs: 'javascript',\n    py: 'python',\n    ipynb: 'python',\n    pyw: 'python',\n    pyi: 'python',\n    el: 'elisp',\n    emacs: 'elisp',\n    ex: 'elixir',\n    exs: 'elixir',\n    go: 'go',\n    eex: 'embedded_template',\n    heex: 'embedded_template',\n    leex: 'embedded_template',\n    html: 'html',\n    htm: 'html',\n    java: 'java',\n    lua: 'lua',\n    ocaml: 'ocaml',\n    ml: 'ocaml',\n    mli: 'ocaml',\n    ql: 'ql',\n    res: 'rescript',\n    resi: 'rescript',\n    rb: 'ruby',\n    erb: 'ruby',\n    rs: 'rust',\n    rdl: 'systemrdl',\n    toml: 'toml',\n    sol: 'solidity',\n  };\n\n  public static async buildParserForFile(filepath: string): Promise<Parser | undefined> {\n    try {\n      await Parser.init({\n        locateFile(scriptName: string, _: string) {\n          return path.join(getRootDir(), getBuildPath(), '/node_modules/web-tree-sitter', scriptName);\n        },\n      });\n      const parser = new Parser();\n      const language = await this.resolveLanguageForFile(filepath);\n\n      if (!language) {\n        return undefined;\n      }\n\n      parser.setLanguage(language);\n      return parser;\n    } catch (e) {\n      // console.debug('Unable to load language for file', filepath, e);\n      return undefined;\n    }\n  }\n\n  private static async resolveLanguageForFile(filepath: string): Promise<Language | undefined> {\n    try {\n      await Parser.init({\n        locateFile(scriptName: string, _: string) {\n          return path.join(getRootDir(), getBuildPath(), '/node_modules/web-tree-sitter', scriptName);\n        },\n      });\n      const extension = path.extname(filepath).slice(1);\n      const languageName = TreeSitter.supportedLanguages[extension];\n      if (!languageName) {\n        // console.log(`Snippet: Unsupported language for file: ${filepath}`);\n        return undefined;\n      }\n\n      let language = TreeSitter.nameToLanguage.get(languageName);\n      if (!language) {\n        language = await this.resolveLanguageForFileExt(extension);\n        TreeSitter.nameToLanguage.set(languageName, language);\n      }\n      return language;\n    } catch (e) {\n      // console.debug('Unable to load language for file', filepath, e);\n      return undefined;\n    }\n  }\n\n  private static async resolveLanguageForFileExt(fileExtension: string): Promise<Language> {\n    const wasmPath = path.join(\n      getRootDir(),\n      getBuildPath(),\n      '/node_modules/@cs/tree-sitter',\n      'tree-sitter-wasms',\n      'out',\n      `tree-sitter-${TreeSitter.supportedLanguages[fileExtension]}.wasm`,\n    );\n    return await Parser.Language.load(wasmPath);\n  }\n\n  public static async loadQueryForFile(\n    filepath: string,\n    queryType: string = 'code-snippet-queries',\n  ): Promise<Parser.Query | undefined> {\n    const language = await this.resolveLanguageForFile(filepath);\n    if (!language) {\n      return undefined;\n    }\n\n    const fullLangName = TreeSitter.supportedLanguages[path.extname(filepath).slice(1)] ?? '';\n    const sourcePath = path.join(\n      getRootDir(),\n      getBuildPath(),\n      '/node_modules/@cs/tree-sitter',\n      'query',\n      queryType,\n      `${fullLangName}.scm`,\n    );\n\n    if (!fs.existsSync(sourcePath)) {\n      return undefined;\n    }\n\n    const querySource = fs.readFileSync(sourcePath).toString();\n    return language.query(querySource);\n  }\n}\n","import { TreeSitter as Parser } from './Parser';\n\nexport default Parser;\n"]}